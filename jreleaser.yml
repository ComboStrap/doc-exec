# Bug in idea, you need to download and map the schema to the below file
# $schema: https://jreleaser.org/schema/jreleaser-schema-1.17.0.json

environment:
  properties:
    jdkPathPrefix: '/tmp/jdks/temurin'
    jdkVersion: '17.0.16'
    jdkDirectoryName: 'jdk-17.0.16+8'
    # The jars are copied via maven with the release profile in the deps directory
    depsPrefix: 'target/deps'

# https://jreleaser.org/guide/latest/reference/project.html
project:
  name: doc-exec
  #version: '{{projectVersion}}'
  description: ComboStrap Doc Exec
  longDescription: |
    Doc Exec, execution of code inside documentation
  authors:
    - Combostrap Team
  inceptionYear: '2025'
  copyright: '2025 Combostrap.com'
  license: Functional Source License, Version 1.1, MIT Future License
  vendor: Combostrap
  snapshot:
    pattern: .*-SNAPSHOT
    # This is the default version value (used in bash script to get the final assembly name)
    label: early-access
  tags:
    - documentation
    - execution
    - markdown
    - wiki
  links:
    homepage: https://github.com/ComboStrap/doc-exec
    documentation: https://github.com/ComboStrap/doc-exec
    bugTracker: https://github.com/ComboStrap/doc-exec/issues
    # LicenseURL (Mandatory for winget)
    license: https://spdx.org/licenses/FSL-1.1-MIT.html
  languages:
    java:
      groupId: com.combostrap
      artifactId: combostrap-doc-exec
      mainClass: com.combostrap.docExec.DocExecutorCli
      version: '16.0.2'
  stereotype: CLI

# Create a GitHub release
# https://jreleaser.org/guide/latest/reference/release/github.html
release:
  github:
    # in docker, repository name must be lowercase
    owner: combostrap
    name: doc-exec
    overwrite: true
    # We create the tag
    skipTag: true
    # When this is a draft, it wonâ€™t be seen by the public unless itâ€™s published.
    draft: false
    # Release by default
    releaseName: "Release {{projectEffectiveVersion}}"
    prerelease:
      # # A regex to determine if the project version is a prerelease
      pattern: .*-rc.*
    # https://jreleaser.org/guide/latest/reference/release/changelog.html
    changelog:
      formatted: ALWAYS
      format: '- {{commitShortHash}} {{commitTitle}}'
      preset: 'conventional-commits'
      contributors:
        enabled: false
      content: |
        # Changelog Version {{projectEffectiveVersion}}

        {{changelogChanges}}
      labelers:
        - label: 'feature'
          title: 'Resolves #'
          body: 'Resolves #'
        - label: 'issue'
          title: 'Fixes #'
          body: 'Fixes #'
        - label: 'issue'
          title: 'Relates to #'
          body: 'Relates to #'
        - label: 'task'
          title: '[chore]'
      categories:
        - title: 'ðŸš€ Features'
          key: 'features'
          labels:
            - 'feature'
        - title: 'âœ… Issues'
          key: 'issues'
          labels:
            - 'issue'
        - title: 'ðŸ§° Tasks'
          key: 'tasks'
          labels:
            - 'task'
      replacers:
        - search: '\[chore\] '

# Execute it with jreleaser assemble
assemble:
  # https://jreleaser.org/guide/latest/reference/assemble/jlink.html
  jlink:
    # Assembly Name
    # Used in the name of the assembly
    # Example: combostrap-early-access-linux-x86_64.zip
    doc-exec:
      active: ALWAYS
      imageName: '{{distributionName}}-{{projectEffectiveVersion}}'
      executable: doc-exec
      jdeps:
        multiRelease: '11'
        ignoreMissingDeps: true
        targets:
          - 'target/combostrap-doc-exec-{{projectVersion}}.jar'
      additionalModuleNames:
        # jdk.crypto.ec is mandatory to avoid handshake_failure on http request
        # https://stackoverflow.com/questions/55439599/sslhandshakeexception-with-jlink-created-runtime
        - 'jdk.crypto.ec'
        # Exception in thread "main" java.lang.NoClassDefFoundError: java/awt/Color
        - 'java.desktop'
        # To compile java code
        - 'jdk.compiler'
        # When compiling, Error: No file system provider is available to handle this file: /opt/doc-exec/jars/lanterna-3.1.3.jar
        - 'jdk.zipfs'
      targetJdks:
        - path: '{{jdkPathPrefix}}Linux/{{jdkDirectoryName}}'
          platform: 'linux-x86_64'
        - path: '{{jdkPathPrefix}}Windows/{{jdkDirectoryName}}'
          platform: 'windows-x86_64'
        - path: '{{jdkPathPrefix}}Osx/{{jdkDirectoryName}}/Contents/Home'
          platform: 'osx-x86_64'
      mainJar:
        path: 'target/combostrap-doc-exec-{{projectVersion}}.jar'
      jars:
        # The jars are copied via maven with the release profile in the deps directory
        - pattern: '{{depsPrefix}}/*.jar'
      swid:
        tagRef: swid-tag
  # https://jreleaser.org/guide/latest/reference/assemble/jpackage.html#_jlink_jpackage
  jpackage:
    doc-exec-jpackage:
      # jpackage tool create only native installers for the platform it's running on
      # https://github.com/jreleaser/jreleaser/blob/main/.github/workflows/step-jpackage.yml
      active: NEVER
      jlink: doc-exec
      linux:
        types: [ rpm ]
      osx:
        types: [ dmg ]
      windows:
        types: [ exe ]
      applicationPackage:
        # additional restrictions on app-version???
        appVersion: 2.0.0


# Distributions define artifacts that may be published using supported packages and announced with supported announcers.
distributions:
  doc-exec:
    # Take the default value from the `assemble` node
    # See with:
    # jreleaser config --quiet  | grep -A 40 '^distributions' | yq
    # grep because the output is not accepted by yq
    type: JLINK

# Create a software BOM (works only for non-snapshot)
catalog:
  active: ALWAYS
  sbom:
    active: ALWAYS
    syft:
      active: ALWAYS

# Create signatures files for the distributions files and the checksum files
signing:
  active: ALWAYS
  mode: COMMAND

packagers:
  brew:
    active: ALWAYS
    multiPlatform: true
  # Publish the `winget` manifests to a git repository
  # so that you can take them and create a pull request to the upstream
  # https://github.com/microsoft/winget-pkgs
  winget:
    active: RELEASE
    repository:
      name: winget-manifests
  docker:
    active: ALWAYS
    useLocalArtifact: true
    baseImage: "debian:bookworm-slim"
    # Wild ! This repository will contain the Dockerfile and the distribution
    repository:
      active: NEVER
    labels:
      org.opencontainers.image.source: "https://{{repoHost}}/{{repoOwner}}/{{repoName}}"
    preCommands:
      - "RUN apt-get update -y && apt-get install unzip && rm -rf /var/lib/apt/lists/*"
    imageNames:
      - "ghcr.io/combostrap/{{distributionName}}:{{tagName}}"
      - "ghcr.io/combostrap/{{distributionName}}:latest"
    registries:
      - serverName: ghcr.io

